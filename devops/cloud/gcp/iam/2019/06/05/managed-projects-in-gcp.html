
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Projects in GCP using Central Billing Accounts - Software, Physics, Data, Mountains</title>
  <meta name="author" content="Mark M Mims, Ph.D.">

  
  <meta name="description" content="Many organizations recognize the benefits of empowering their developers. In a
cloud environment, that often means giving developers the ability to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://markmims.com/devops/cloud/gcp/iam/2019/06/05/managed-projects-in-gcp.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Software, Physics, Data, Mountains" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4132881-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Software, Physics, Data, Mountains</a></h1>
  
    <h2>...and other random associations</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:markmims.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about.html">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Projects in GCP Using Central Billing Accounts</h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-06-05T00:00:00+00:00" pubdate data-updated="true">Jun 5<span>th</span>, 2019</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Many organizations recognize the benefits of empowering their developers. In a
cloud environment, that often means giving developers the ability to create and
manage their own infrastructure.</p>

<p>Of course, developers can easily create their own individual or G-Suite GCP
accounts.  They can take advantage of the free trial that Google Cloud offers.
That&#8217;s great, and everything&#8217;s hunky-dory until the credit runs out. What then?</p>

<p>In this post I describe a really simple way to set up and use centralized
billing on GCP&#8230; even across external development accounts.  Way better than
trying to get me to fill out expense reports for infradev!</p>

<!--more-->

<h2 id="contents">Contents</h2>

<ul>
  <li>Organizations and account setup</li>
  <li>Users and IAM roles</li>
  <li>Terraform templates</li>
  <li>Try it out</li>
</ul>

<h2 id="organizations-and-account-setup">Organizations and account setup</h2>

<p>Let&#8217;s consider a common example with two separate organizations in the mix.</p>

<ol>
  <li>
    <p>A <code>bigcorp.com</code> organization that&#8217;s footing the bill for everything</p>
  </li>
  <li>
    <p>An individual developer&#8217;s G-Suite organization, <code>pinkponies.io</code>, where
we&#8217;ll be doing the development</p>
  </li>
</ol>

<p>In this example, we&#8217;re assuming the developer organization <code>pinkponies.io</code> is a
full G-Suite account and not just an ordinary GCP account created using a
single email.</p>

<p>It&#8217;s easy for an individual developer to create a new G-Suite account and that
turns out to be the more typical situation for this kind of cross billing
example. I also really recommend using developer G-Suite accounts for cloud
development in general since they&#8217;ll have the same IAM capabilities and
concerns as the <code>bigcorp.com</code> account.</p>

<h2 id="users-and-iam-roles">Users and IAM roles</h2>

<p>Each developer will need accounts in both orgs to start with.</p>

<p>Take Sam for example. Sam&#8217;s already an Owner of <code>pinkponies.io</code>&#8230;  with
<code>sam@pinkponies.io</code> as a login.</p>

<p>Sam works for BigCorp and is also <code>sam@bigcorp.com</code> where they live in some
folder within the <code>bigcorp.com</code> organization&#8217;s GCP IAM.</p>

<h3 id="in-your-billing-org-bigcorpcom">In your billing org: <code>bigcorp.com</code></h3>

<p>So the <code>billing_account_user</code> (<code>sam@bigcorp.com</code>) needs to be able to create
billing accounts within the BigCorp org.</p>

<p>Sam will need to be assigned a <code>BillingAccountCreator</code> role within the
<code>bigcorp.com</code> org&#8217;s IAM on GCP.</p>

<h3 id="in-your-gsuite-org-pinkponiesio">In your gsuite org: <code>pinkponies.io</code></h3>

<p>It&#8217;s no surprise, the <code>gsuite_user</code> (<code>sam@pinkponies.io</code>) needs to be an
<code>OrganizationAdministrator</code> on that org.</p>

<p>The <code>billing_account_user</code> (<code>sam@bigcorp.com</code>) needs permissions on the
<code>pinkponies.io</code> org too. They need to be:</p>

<ul>
  <li>a <code>BillingAccountAdministrator</code> for the <code>pinkponies.io</code> org</li>
  <li>a <code>ProjectCreator</code> on the <code>pinkponies.io</code> org</li>
  <li>and I added them as an <code>OrganizationAdministrator</code> on <code>pinkponies.org</code> for
good measure</li>
</ul>

<h2 id="terraform-templates">Terraform templates</h2>

<p>I like to manage infrastructure using <a href="terraform.io">Terraform</a> and keep
all my templates and modules checked into GitHub.</p>

<p>The Terraform templates to create these projects are super simple. There&#8217;s a
provider, a resource for the managed project we want to create, and then a
couple of role binding resources</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class=""><span class="line">provider "google" {
</span><span class="line">  region      = "${var.region}"
</span><span class="line">}
</span><span class="line">
</span><span class="line">resource "google_project" "gsuite_project" {
</span><span class="line">  name       = "gsuite-project-0"
</span><span class="line">  project_id = "gsuite-project-0"
</span><span class="line">
</span><span class="line">  org_id = "${var.gsuite_org_id}"
</span><span class="line">  billing_account = "${var.billing_account_id}"
</span><span class="line">}
</span><span class="line">
</span><span class="line">resource "google_project_iam_binding" "gsuite_project_owner" {
</span><span class="line">  project = "${google_project.gsuite_project.project_id}"
</span><span class="line">  role    = "roles/owner"
</span><span class="line">
</span><span class="line">  members = [
</span><span class="line">    "user:${var.gsuite_user}",
</span><span class="line">    "user:${var.billing_account_user}",
</span><span class="line">  ]
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There&#8217;s no need to get Terraform to slurp in data sources for the GCP orgs,
folders, billing accounts, etc. In this example, we&#8217;ll just create variables
for them</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class=""><span class="line">variable "region" {
</span><span class="line">  default = "us-central1"
</span><span class="line">}
</span><span class="line">
</span><span class="line">variable "billing_account_user" {}
</span><span class="line">variable "billing_folder_id" {}
</span><span class="line">variable "billing_account_id" {}
</span><span class="line">
</span><span class="line">variable "gsuite_user" {}
</span><span class="line">variable "gsuite_org_id" {}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and look up the values from the cloud consoles for both our <code>bigcorp.com</code> and
<code>pinkponies.io</code> accounts.  We&#8217;ll add these to <code>terraform.tfvars</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">billing_account_user = "sam@bigcorp.com"
</span><span class="line">billing_folder_id = "234567890123" # my-billing-folder
</span><span class="line">billing_account_id = "aaaaaa-bbbbbb-cccccc" # my-billing-account
</span><span class="line">
</span><span class="line">gsuite_user = "sam@pinkponies.io"
</span><span class="line">gsuite_org_id = "345678901234" # pinkponies.io</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that there&#8217;s a <code>terraform.tfvars.template</code> included in the example repo
but the actual <code>*.tfvars</code> files, with sensitive account details, are ignored by
revision control so you&#8217;ll have to copy the template and create your own
<code>terraform.tfvars</code>.</p>

<h2 id="try-it-out">Try it out</h2>

<h3 id="example-repo">Example repo</h3>

<p>You can clone and configure the example templates</p>

<ul>
  <li>clone <a href="https://github.com/mmm/gcp-managed-projects">https://github.com/mmm/gcp-managed-projects</a></li>
  <li>copy the tfvars template over to <code>terraform.tfvars</code> and edit it with your info</li>
</ul>

<h3 id="gcloud"><code>gcloud</code></h3>

<p>Terraform&#8217;s provider for GCP needs GCP credentials for your account.  The
easiest thing to do to get that working before trying to run Terraform is to
make sure gcloud is working correctly.</p>

<p>You can do that by installing gcloud and running <code>gcloud init</code> to go through
the oauth dance&#8230; that works.  You&#8217;d need to export your
<code>GOOGLE_APPLICATION_CREDENTIALS</code> as well&#8230; usual stuff.</p>

<p>However, as an easier alternative, use the cloud shell in the cloud console for
your <code>bigcorp.com</code> equivalent account.  The gcloud config and applcation
credentials are all already set up for you.</p>

<p>Side note: The cloud shell is <em>really</em> useful&#8230; check it out if you haven&#8217;t!</p>

<p>Make sure you&#8217;re driving terraform using credentials (your <code>gcloud</code> config)
from the equivalent of your <code>bigcorp.com</code> account and <em>not</em> your
<code>pinkponies.io</code> G-Suite org account.</p>

<h3 id="terraform">Terraform</h3>

<p>Download Terraform from <a href="https://terraform.io/">https://terraform.io/</a>.  Terraform is a standalone
binary so it&#8217;s simple to install&#8230; even in your GCP Cloud Shell.</p>

<p>Init terraform&#8217;s providers and state management</p>

<pre><code>terraform init
</code></pre>

<p>Then check out what changes we&#8217;re _plan_ning to make</p>

<pre><code>terraform plan
</code></pre>

<p>If all looks good from there, then <em>apply</em> that plan to actually create our
project</p>

<pre><code>terraform apply
</code></pre>

<p>Check out the project we just created</p>

<pre><code>gcloud beta billing projects list --billing-account=&lt;billing_account_id&gt;
</code></pre>

<p>Check out the same project from the Cloud Console for your <code>pinkponies.io</code>
G-Suite account.</p>

<p>Now you can use that account within your <code>pinkponies.io</code> G-Suite account and
any charges go straight to your BigCorp billing account.</p>

<h3 id="cleanup">Cleanup</h3>

<p>When you&#8217;re all done, you can clean up after yourself by removing the project
and role bindings we created</p>

<pre><code>terraform destroy
</code></pre>

<p>then deleting the billing account through the Cloud Console.  You could (and
should) totally manage the billing accounts themselves in the bigcorp.org using
Terraform templates as well, but that&#8217;s another story.</p>

<h2 id="disclaimer">Disclaimer</h2>

<p>No big corps or pink ponies were harmed in the production of this post.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark M Mims, Ph.D.</span></span>

      








  


<time datetime="2019-06-05T00:00:00+00:00" pubdate data-updated="true">Jun 5<span>th</span>, 2019</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cloud/'>cloud</a>, <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/gcp/'>gcp</a>, <a class='category' href='/blog/categories/iam/'>iam</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://markmims.com/devops/cloud/gcp/iam/2019/06/05/managed-projects-in-gcp.html" data-via="m_3" data-counturl="http://markmims.com/devops/cloud/gcp/iam/2019/06/05/managed-projects-in-gcp.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/data-engineering/spark/hadoop/devops/2016/03/17/hwtb-sessions.html" title="Previous Post: Identifying User Activity from Streams of Raw Events">&laquo; Identifying User Activity from Streams of Raw Events</a>
      
      
        <a class="basic-alignment right" href="/mids/ubuntu/2020/07/29/screencasts-with-ffmpeg.html" title="Next Post: Screencasts on Ubuntu using `ffmpeg`">Screencasts on Ubuntu using `ffmpeg` &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="comments_note" aria-live="polite"><p>If you have any questions or feedback, please feel free to share it with me on Twitter: <a href="https://twitter.com/m_3">@m_3</a></p>
</div>
  </section>
</div>

<aside class="sidebar">
  
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <section>
    <div id='container'>
      <div id='about-sidebar'>
      </div>
      <br/>
    </div>
    <script type='text/javascript'>
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type='text/javascript'>
      var pageTracker = _gat._getTracker("UA-4132881-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>
  </section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/mids/ubuntu/2020/07/29/screencasts-with-ffmpeg.html">Screencasts on Ubuntu using `ffmpeg`</a>
      </li>
    
      <li class="post">
        <a href="/devops/cloud/gcp/iam/2019/06/05/managed-projects-in-gcp.html">Projects in GCP using Central Billing Accounts</a>
      </li>
    
      <li class="post">
        <a href="/data-engineering/spark/hadoop/devops/2016/03/17/hwtb-sessions.html">Identifying User Activity from Streams of Raw Events</a>
      </li>
    
      <li class="post">
        <a href="/docker/data-engineering/spark/devops/2015/10/13/docker-cdh.html">Develop Spark Apps on Yarn using Docker</a>
      </li>
    
      <li class="post">
        <a href="/2015/06/01/ssh-tips.html">SSH Tips and Tricks</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Mark M Mims, Ph.D. -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
