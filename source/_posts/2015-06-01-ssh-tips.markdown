---
layout: post
title: "SSH Tips and Tricks"
date: 2015-06-01 16:00
comments: true
categories: 
---


Notes from a lunch-and-learn talk.  It's a little weak without the narrative,
but I'll post it here for reference anyway.

Agenda:

- config
- tunnels
    - forward
    - reverse
- proxies
- ssh + tmux = <3
    - ssh, then tmux
    - tmux, then ssh

<!-- more -->


# Config

In your home directory, put a `~/.ssh/config` file...

## you can use this for simple aliases...

    #################
    # MyBastions
    #################
    Host customerXbastion
        Hostname ec2-xxx-xxx-xxx-xxx.compute-1.amazonaws.com
    Host customerYbastion
        Hostname ec2-yyy-yyy-yyy-yyy.compute-1.amazonaws.com
    Host customerZbastion
        Hostname ec2-zzz-zzz-zzz-zzz.compute-1.amazonaws.com 


## or adding extra stuff that's a pain to type _every_ time

    ############
    # CustomerX
    ############
    Host dev-control-*.customerX.com
        User ubuntu
        IdentityFile ~/projects/customerX/creds/dev_control.pem
    Host dev-es-*.customerX.com
        User ubuntu
        IdentityFile ~/projects/customerX/creds/dev_es.pem
    Host dev-hdp-*.customerX.com
        User ubuntu
        IdentityFile ~/projects/customerX/creds/dev_hdp.pem
    (etc)


## or to include tunnels

    Host myserver
        Hostname 10.2.3.4
        LocalForward 7080 localhost:7080
        LocalForward 8080 localhost:8080


## or to include proxies

    #############
    # CustomerY
    #############
    Host customerYbastion
        Hostname ec2-yyy-yyy-yyy-yyy.compute-1.amazonaws.com
        User ubuntu
        ProxyCommand none
    Host *.inside.customerY.com
        User ubuntu
        ProxyCommand ssh customerYbastion nc -q0 %h %p


\pagebreak



# Proxies

# ssh using a bastion





         +--------------------+         +-------------------+
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |    laptop          |         |      bastion      |
         |                    |  ssh    |                   |
         |                    +--------->                   +
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         |                    |         |                   |
         +--------------------+         +-------------------+

         `ssh bastion`


and then



                                        +-------------------+          +-------------------+
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |      bastion      |          |     target        |
                                        |                   |  ssh     |                   |
                                        |                   +---------->                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        |                   |          |                   |
                                        +-------------------+          +-------------------+


                                        `ssh target`



can we compress this to one step?


         +--------------------+         +-------------------+       +-------------------+
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |    laptop          |         |      bastion      |       |      target       |
         |                    |  ssh    |                   |  ssh  |                   |
         |                    +--------->                   +------->                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         |                    |         |                   |       |                   |
         +--------------------+         +-------------------+       +-------------------+


Yes!

From laptop's `~/.ssh/config` file:

    Host bastion
        Hostname ec2-xxx.xxx.....amazon.com
    Host target
        Hostname ip-10-xx-xx-xx.internal....amazon.com
        ProxyCommand ssh bastion nc -q1 %h %p

then you can just `ssh target` directly from your laptop.
    



\pagebreak




# Tunnels

## ssh in general is a tunnel


            +-----------------------+                             +------------------------+
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |            Inet             |                        |
            |                       |                             |                        |
            |                       +----------------------------->                        |
            |                       +         <-- text -->        |           fred         |
            |                       +                             |                        |
            |        laptop         +----------------------------->      (ec2 instance)    |
            |                       |                             |                        |
            |                       |                             |    (any remote server) |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             +------------------------+
            +-----------------------+



    `ssh fred`



## forward tunnels

aka, "port forwarding"


### forwarding web traffic


              +----------------+                  +------------------------+
              |                |                  |                        |
              |                |                  |                        |
              |                |                  |                        |
    -- 8888 ->|                |                  |                        |
              |                +------------------>                        |
              |                +   <-- text -->   |                        |
              |                +   <--  web -->   |                        | ----->  http://nfl.com/
              |     laptop     +------------------>      ec2 instance      |
              |                |                  |                        |
              |                |                  |    (any remote server) |
              |                |                  |                        |
              |                |                  |                        |
              |                |                  |                        |
              |                |                  |                        |
              |                |                  |                        |
              |                |                  |                        |
              |                |                  +------------------------+
              +----------------+


    `ssh fred -L8888:www.nfl.com:80`

    `open http://localhost:8888/`





### forwarding localhost



              +------------+                +------------------------+
              |            |                |                        |
              |            |                |                        |
    -- 50070->|            |                |                        |
              |            |                |                        | http://...  <---+
              |            |                |                        |    (50070)      |
              |            +---------------->                        |                 |
              |            +    <----->     |                        |                 |
              |            +    <----->     |                        | ----------------+
              |  laptop    +---------------->      ec2 instance      |
              |            |                |                        |
              |            |                |    (any remote server) |
              |            |                |                        |
              |            |                |                        |
              |            |                |                        |
              |            |                |                        |
              |            |                |                        |
              |            |                |                        |
              |            |                +------------------------+
              +------------+


    `ssh fred -L8888:localhost:80`

or, perhaps more useful...

    `ssh fred -L50070:localhost:50070`
    `open http://localhost:50070/`

or 

    `ssh fred -L50070:localhost:50070 -L50030:localhost:50030`




## reverse tunnels


            +-----------------------+                             +------------------------+
            |                       |                             |                        |
            |                       |                   -- 2222 ->|                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       |                             |                        |
            |                       +----------------------------->                        |
            |                       +            <----->          |                        |
            |                       +            <----->          |                        |
            |        laptop         +----------------------------->      ec2 instance      |
            |                       |                             |                        |
            |                       |                             |    (any remote server) |
            |                       |                             |                        |
            |                       | 22 <---+                    |                        |
            |                       |        |                    |                        |
            |                       |        |                    |                        |
            |                       |--------+                    |                        |
            |                       |                             |                        |
            |                       |                             +------------------------+
            +-----------------------+



    `ssh fred -R2222:localhost:22`

or maybe something like...


    `ssh fred -R8888:localhost:80`

or even `ssh root@fred -R80:localhost:80`




## add forwarding to your ssh config


    Host myhost
        Hostname 10.1.2.3
        LocalForward 7080 localhost:7080
        LocalForward 8080 localhost:8080


\pagebreak
